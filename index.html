<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MEGA COMPLEX SITE ‚Äî @its.gbzin_ (Single File, Firebase) </title>
<meta name="description" content="Mega site single-file do @its.gbzin_ ‚Äî posts em tempo real, auth, upload, modera√ß√£o, admin panel, offline cache e muito mais." />
<meta name="author" content="@its.gbzin_" />
<meta name="theme-color" content="#0b1221" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='60'%3Eüåê%3C/text%3E%3C/svg%3E">

<!-- Structured data for SEO -->
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"WebSite",
  "name":"its.gbzin_ ‚Äî Mega Site",
  "url":"https://instagram.com/its.gbzin_",
  "author": {"@type":"Person","name":"its.gbzin_","sameAs":["https://instagram.com/its.gbzin_"]},
  "potentialAction": {"@type":"SearchAction","target":"?q={search_term}","query-input":"required name=search_term"}
}
</script>

<style>
/* =========================================================
   Mega CSS - structured, commented, and extensible
   - Use variables for easy theming
   - Responsive grid layout
   - Accessible focus states
   ========================================================= */
:root{
  --bg:#05060a;
  --panel:#0f1724;
  --muted:#9aa4b2;
  --accent:#7c3aed;
  --accent-2:#06b6d4;
  --glass:rgba(255,255,255,0.03);
  --radius:12px;
  --max-width:1400px;
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Segoe UI Mono", monospace;
  --ease: cubic-bezier(.2,.9,.2,1);
}

/* Reset / base */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  padding:18px;
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:
    radial-gradient(900px 400px at 10% 10%, rgba(124,58,237,0.06), transparent),
    linear-gradient(180deg,#020217 0%, var(--bg) 100%);
  color:#e6eef8;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.45;
}

/* Wrapper */
.wrap{max-width:var(--max-width);margin:0 auto;display:flex;flex-direction:column;gap:18px}

/* Header */
.header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px;border-radius:10px;
  background:linear-gradient(180deg, rgba(255,255,255,0.018), transparent);
  border:1px solid rgba(255,255,255,0.03);
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:68px;height:68px;border-radius:14px;display:grid;place-items:center;font-weight:900;
  background:linear-gradient(135deg,var(--accent),var(--accent-2));
  box-shadow:0 8px 30px rgba(2,6,23,0.7);
}
.title h1{margin:0;font-size:18px}
.title p{margin:0;color:var(--muted);font-size:13px}

/* Nav */
.nav{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));padding:8px 12px;border-radius:10px;border:0;color:#041026;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
.btn.small{padding:6px 8px;font-size:13px}
a.btn{display:inline-block;text-decoration:none}

/* Layout */
main{display:grid;grid-template-columns:1fr 420px;gap:18px}
@media (max-width:1060px){ main{grid-template-columns:1fr} .right{order:-1} }

/* Panels */
.panel{background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(2,6,23,0.6)}
.small{font-size:13px;color:var(--muted)}

/* Hero */
.hero{display:flex;align-items:center;gap:18px}
.hero .left{flex:1}
.hero h2{margin:0;font-size:22px}
.tag{display:inline-block;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041026;font-weight:800}

/* Grid helpers */
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
@media (max-width:720px){ .grid{grid-template-columns:1fr} }

/* Portfolio / thumbs */
.portfolio{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media (max-width:980px){ .portfolio{grid-template-columns:repeat(2,1fr)} }
@media (max-width:520px){ .portfolio{grid-template-columns:1fr} }

.thumb{height:110px;border-radius:10px;background:linear-gradient(135deg, rgba(124,58,237,0.12), rgba(6,182,212,0.06));display:flex;align-items:center;justify-content:center;font-weight:700;position:relative;overflow:hidden}

/* Posts */
.post-form{display:flex;flex-direction:column;gap:8px}
input[type="text"], input[type="email"], textarea, select { background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:8px;color:inherit;width:100% }
input[type="file"]{color:var(--muted)}
.post-actions{display:flex;gap:8px;align-items:center}
#postsFeed{display:grid;gap:12px;margin-top:12px}

/* Single post */
.post{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.post .meta{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:13px}
.post img{max-width:100%;border-radius:8px;margin-top:10px}
.actions{display:flex;gap:8px;margin-top:8px}

/* Right column helpers */
.right{display:flex;flex-direction:column;gap:12px}

/* Big mega blocks (for record) */
.mega-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:12px}

/* Footer */
footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px;padding:12px}

/* Accessibility */
:focus{outline:3px solid rgba(124,58,237,0.25);outline-offset:2px}
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* Tiny responsive tweaks */
@media (max-width:420px){
  .logo{width:56px;height:56px}
  .title h1{font-size:16px}
}
</style>
</head>
<body>
<div class="wrap" id="app">
  <!-- HEADER -->
  <header class="header" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true">GBZ</div>
      <div class="title">
        <h1>@its.gbzin_ ‚Äî Mega Complex Site</h1>
        <p class="small">Contato: <strong id="phone-display">15 996228860</strong> ‚Ä¢ Instagram: <strong>@its.gbzin_</strong></p>
      </div>
    </div>

    <nav class="nav" role="navigation" aria-label="Principal">
      <button class="btn" onclick="scrollToId('hero')">In√≠cio</button>
      <button class="btn ghost" onclick="scrollToId('posts')">Posts</button>
      <button class="btn ghost" onclick="scrollToId('admin')">Admin</button>
      <a class="btn small" id="open-ig" href="https://instagram.com/its.gbzin_" target="_blank" rel="noopener">@its.gbzin_</a>
      <button id="auth-btn" class="btn ghost small">Entrar (Google)</button>
    </nav>
  </header>

  <!-- MAIN LAYOUT -->
  <main>
    <!-- LEFT / MAIN -->
    <section>
      <!-- HERO -->
      <div class="panel hero" id="hero" role="region" aria-labelledby="hero-title">
        <div class="left">
          <div class="tag">Recorde ‚Ä¢ Mega ‚Ä¢ Complexo</div>
          <h2 id="hero-title">O site single-file mais complexo para @its.gbzin_ ‚Äî posts em tempo real, uploads, auth, admin e muito mais.</h2>
          <p class="small" style="margin-top:8px">Feito para escalar e ser modificado ‚Äî com coment√°rios, explica√ß√µes e m√≥dulos prontos para voc√™ adaptar. Este arquivo cont√©m componentes, l√≥gica de frontend e integra√ß√£o com Firebase (Firestore + Storage + Auth).</p>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" onclick="scrollToId('posts')">Ir para Posts</button>
            <button class="btn ghost" id="download-vcard">Baixar vCard</button>
            <button class="btn ghost" onclick="copyToClipboard('@its.gbzin_')">Copiar IG</button>
            <button class="btn ghost" onclick="copyToClipboard('15 996228860')">Copiar Telefone</button>
          </div>
        </div>

        <div style="width:220px;text-align:right">
          <div class="small muted">Status Firebase</div>
          <div id="fb-status" class="small">inicializando...</div>
        </div>
      </div>

      <!-- SECTIONS GRID -->
      <div class="grid" style="margin-top:12px">
        <div class="panel">
          <h3>Servi√ßos</h3>
          <p class="small muted">Design, conte√∫do, desenvolvimento e consultoria.</p>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <span class="small">Branding</span><span class="small">Landing</span><span class="small">Reels</span><span class="small">Web</span>
          </div>
        </div>

        <div class="panel">
          <h3>Sobre</h3>
          <p class="small muted">Profissional com presen√ßa digital e projetos multifacetados. Use o painel admin para gerenciar conte√∫do.</p>
        </div>

        <div class="panel">
          <h3 id="conteudos">Conte√∫dos</h3>
          <p class="small muted">Tutoriais, an√°lises, listas e ideias para criadores.</p>
        </div>

        <div class="panel">
          <h3>Portf√≥lio</h3>
          <div class="portfolio" style="margin-top:8px">
            <div class="thumb">Identidade</div>
            <div class="thumb">Landing</div>
            <div class="thumb">Evento</div>
          </div>
        </div>
      </div>

      <!-- POSTS (big section) -->
      <div class="panel" id="posts" style="margin-top:14px" role="region" aria-labelledby="posts-title">
        <h2 id="posts-title">Posts em tempo real ‚Äî publique, curta, comente e fa√ßa upload</h2>
        <p class="small muted">Login com Google adiciona verifica√ß√£o; an√¥nimos tamb√©m podem publicar (modo demo).</p>

        <!-- FORM -->
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="flex:1;min-width:260px">
            <div class="post-form">
              <input id="post-title" type="text" placeholder="T√≠tulo (opcional)" aria-label="T√≠tulo do post" />
              <textarea id="post-text" rows="4" placeholder="Compartilhe algo..." aria-label="Texto do post"></textarea>
              <input id="post-image" type="file" accept="image/*" aria-label="Imagem do post" />
              <div class="post-actions">
                <button id="btn-post" class="btn">Publicar</button>
                <button class="btn ghost" onclick="setModKey()">Definir chave mod</button>
                <button class="btn ghost" onclick="clearModKey()">Limpar chave</button>
                <div id="upload-progress" class="small" style="margin-left:8px"></div>
              </div>
              <div id="post-msg" class="small muted" style="margin-top:8px"></div>
            </div>
          </div>

          <div style="width:320px">
            <div class="panel">
              <div class="small muted">Quem est√° online</div>
              <div id="user-info" style="margin-top:8px">An√¥nimo</div>
              <div style="height:8px"></div>
              <div class="small muted">Chave local de modera√ß√£o</div>
              <div id="mod-ind" class="small muted">nenhuma</div>
              <div style="height:8px"></div>
              <div class="small muted">Pesquisar posts</div>
              <input id="search" placeholder="Filtro..." oninput="renderPosts()" />
            </div>
          </div>
        </div>

        <!-- POSTS FEED -->
        <div id="postsFeed" aria-live="polite" style="margin-top:12px"></div>
      </div>

      <!-- GIANT SECTION for record -->
      <div class="panel" style="margin-top:12px">
        <h2>Se√ß√µes gigantes (gera centenas de blocos)</h2>
        <p class="small muted">Use para encher o site e deixar impressionante ‚Äî gerado automaticamente pelo script.</p>
        <div id="megaGrid" class="mega-grid"></div>
      </div>

      <!-- ADMIN PANEL (hidden for normal users) -->
      <div id="admin" class="panel" style="margin-top:12px">
        <h2>Admin & Moderation</h2>
        <p class="small muted">Ferramentas de administra√ß√£o para moderar posts, ver estat√≠sticas e executar a√ß√µes de massa (cuidado!).</p>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <button class="btn ghost" onclick="openModeration()">Abrir modera√ß√£o</button>
          <button class="btn ghost" onclick="generateDemoPosts(10)">Gerar 10 posts demo</button>
          <button class="btn ghost" onclick="exportPosts()">Exportar posts (JSON)</button>
          <button class="btn ghost" onclick="importSample()">Importar amostra</button>
        </div>

        <div id="admin-panel" style="margin-top:12px"></div>
      </div>

    </section>

    <!-- RIGHT COLUMN -->
    <aside class="right" role="complementary">
      <div class="panel">
        <h3>Contato R√°pido</h3>
        <div class="small muted">WhatsApp</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1">15 996228860</div>
          <a id="wa-link" class="btn ghost small" target="_blank" rel="noopener">Abrir WhatsApp</a>
        </div>

        <div style="height:8px"></div>
        <div class="small muted">Instagram</div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <div style="flex:1">@its.gbzin_</div>
          <a class="btn ghost small" href="https://instagram.com/its.gbzin_" target="_blank" rel="noopener">Abrir</a>
        </div>
      </div>

      <div class="panel">
        <h3>Estat√≠sticas</h3>
        <div class="small muted" style="margin-top:8px">Posts totais: <strong id="count">0</strong></div>
        <div class="small muted" style="margin-top:6px">Curtidas totais: <strong id="likes-total">0</strong></div>
        <div style="height:8px"></div>
        <div class="small muted">Conex√£o Firebase:</div>
        <div id="con-status" class="small muted">‚Äî</div>
      </div>

      <div class="panel">
        <h3>Assine novidades</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="news-email" placeholder="seu@email.com" />
          <button class="btn" onclick="fakeSubscribe()">Assinar</button>
        </div>
        <div id="news-msg" class="small muted" style="margin-top:8px"></div>
      </div>

    </aside>
  </main>

  <footer>
    ¬© <span id="year"></span> @its.gbzin_ ‚Ä¢ Contato: 15 996228860 ‚Ä¢ Mega Complex Site
  </footer>
</div>

<!-- =========================================================
     Firebase (compat libraries for simplicity in single file)
     If you prefer modular SDK (v9) we can refactor to imports.
     ========================================================= -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* =========================================================
   CONFIGURA√á√ÉO FIREBASE - Use a configura√ß√£o que voc√™ forneceu
   (j√° enviada por voc√™). N√£o altere se n√£o for necess√°rio.
   ========================================================= */
const firebaseConfig = {
  apiKey: "AIzaSyANLqvkka2W2Fbnm59I-MXEm-nEo_is1Sw",
  authDomain: "gbxui-b5063.firebaseapp.com",
  projectId: "gbxui-b5063",
  storageBucket: "gbxui-b5063.firebasestorage.app",
  messagingSenderId: "57132814774",
  appId: "1:57132814774:web:e4583040dd27a8ab637117"
};

/* =========================================================
   Inicializa√ß√£o Firebase
   ========================================================= */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* =========================================================
   Estado / caches locais
   ========================================================= */
let currentUser = null;
let postsCache = {}; // id -> doc data
let totalLikes = 0;

/* =========================================================
   Utilit√°rios gerais
   ========================================================= */
function $(sel){ return document.querySelector(sel); }
function $all(sel){ return Array.from(document.querySelectorAll(sel)); }
function toast(msg, time=1800){
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.position='fixed';el.style.right='18px';el.style.bottom='18px';
  el.style.padding='10px 14px';el.style.background='rgba(0,0,0,0.7)';
  el.style.color='white';el.style.borderRadius='10px';el.style.zIndex=9999;
  document.body.appendChild(el);
  setTimeout(()=>el.style.opacity='0', time-500);
  setTimeout(()=>el.remove(), time);
}
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); toast('Copiado: ' + text); }catch(e){ alert('Falha ao copiar: ' + text); }
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/\n/g,'<br>'); }
function scrollToId(id){ document.getElementById(id)?.scrollIntoView({behavior:'smooth'}); }

/* =========================================================
   Inicializa√ß√µes visuais
   ========================================================= */
document.getElementById('year').textContent = new Date().getFullYear();
document.getElementById('wa-link').href = 'https://wa.me/5515996228860';
document.getElementById('phone-display').textContent = '15 996228860';

/* =========================================================
   Auth: Google Sign-in + anonymous fallback
   - auth.onAuthStateChanged mant√©m currentUser
   - auth with popup requires domain authorized in Firebase console
   ========================================================= */
const authBtn = document.getElementById('auth-btn');
authBtn.addEventListener('click', async ()=>{
  if(currentUser){
    await auth.signOut();
    return;
  }
  const provider = new firebase.auth.GoogleAuthProvider();
  try {
    await auth.signInWithPopup(provider);
  } catch (e) {
    console.warn('Auth popup falhou, tentando auth anon:', e);
    try{
      await auth.signInAnonymously();
      toast('Entrou como an√¥nimo (popup bloqueado).');
    }catch(err){ alert('Erro autentica√ß√£o: ' + err.message); }
  }
});

auth.onAuthStateChanged(user=>{
  currentUser = user;
  if(user){
    // display user info
    const name = user.displayName || 'Usu√°rio';
    const mail = user.email || 'an√¥nimo';
    const photo = user.photoURL || '';
    $('#user-info').innerHTML = `
      <div style="display:flex;gap:8px;align-items:center">
        ${photo ? `<img src="${photo}" alt="" style="width:40px;height:40px;border-radius:999px;object-fit:cover" />` : ''}
        <div>
          <div style="font-weight:800">${escapeHtml(name)}</div>
          <div class="small muted">${escapeHtml(mail)}</div>
        </div>
      </div>
    `;
    authBtn.textContent = 'Sair';
  } else {
    $('#user-info').textContent = 'An√¥nimo';
    authBtn.textContent = 'Entrar (Google)';
  }
});

/* =========================================================
   MOD KEY (local) - simples, salva no localStorage
   - usado para demo de modera√ß√£o
   ========================================================= */
function setModKey(){
  const k = prompt('Defina uma chave local de modera√ß√£o (ser√° salva no navegador):');
  if(k){ localStorage.setItem('gbz_mod_key', k); updateModIndicator(); toast('Chave salva'); }
}
function clearModKey(){ localStorage.removeItem('gbz_mod_key'); updateModIndicator(); toast('Chave limpa'); }
function getModKey(){ return localStorage.getItem('gbz_mod_key') || null; }
function updateModIndicator(){ $('#mod-ind').textContent = getModKey() ? 'salva' : 'nenhuma'; }
updateModIndicator();

/* =========================================================
   vCard download
   ========================================================= */
$('#download-vcard').addEventListener('click', ()=>{
  const vcard = [
    'BEGIN:VCARD',
    'VERSION:3.0',
    'FN:its.gbzin_',
    'TEL;TYPE=WORK,VOICE:+5515996228860',
    'URL:https://instagram.com/its.gbzin_',
    'NOTE:Contato profissional ‚Äî Instagram: @its.gbzin_',
    'END:VCARD'
  ].join('\r\n');
  const blob = new Blob([vcard], {type:'text/vcard'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='its-gbzin.vcf'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('vCard gerado');
});

/* =========================================================
   POSTS: create (with optional image upload), like, remove
   - Firestore collection: posts
   - Storage path: posts/{id}/image.ext
   ========================================================= */
$('#btn-post').addEventListener('click', async ()=>{
  const title = $('#post-title').value.trim();
  const text = $('#post-text').value.trim();
  const file = $('#post-image').files[0];
  if(!text && !file){ alert('Adicione texto ou imagem'); return; }

  const meta = {
    title: title || '',
    text: text || '',
    ts: Date.now(),
    likes: 0,
    uid: currentUser ? currentUser.uid : null,
    authorName: currentUser ? (currentUser.displayName || currentUser.email) : 'an√¥nimo',
    authorPhoto: currentUser ? currentUser.photoURL || '' : ''
  };

  try {
    $('#post-msg').textContent = 'Publicando...';
    // create doc
    const docRef = await db.collection('posts').add(meta);
    const id = docRef.id;

    if(file){
      // file upload with progress
      const ext = file.name.split('.').pop().slice(0,8);
      const path = `posts/${id}/image.${ext}`;
      const uploadTask = storage.ref(path).put(file);

      uploadTask.on('state_changed', snapshot=>{
        const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
        $('#upload-progress').textContent = `Upload: ${pct}%`;
      });

      const snap = await uploadTask;
      const url = await snap.ref.getDownloadURL();
      await docRef.update({ imageURL: url });
      $('#upload-progress').textContent = 'Upload conclu√≠do';
    }

    // Cleanup
    $('#post-title').value = ''; $('#post-text').value = ''; $('#post-image').value = '';
    $('#post-msg').textContent = '';
    toast('Post publicado');
  } catch (err) {
    console.error('Erro publicar', err);
    $('#post-msg').textContent = 'Erro: ' + err.message;
  }
});

/* =========================================================
   Like: atomic transaction using Firestore transactions
   ========================================================= */
async function likePost(id){
  const docRef = db.collection('posts').doc(id);
  try{
    await db.runTransaction(async t => {
      const doc = await t.get(docRef);
      if(!doc.exists) throw 'Post n√£o existe';
      const cur = doc.data().likes || 0;
      t.update(docRef, { likes: cur + 1 });
    });
  } catch(e){ console.error('like error', e); }
}

/* =========================================================
   Remove post: allowed if author OR mod key (demo)
   Also removes image from Storage if present (best-effort)
   ========================================================= */
async function removePost(id){
  const docRef = db.collection('posts').doc(id);
  try {
    const doc = await docRef.get();
    if(!doc.exists){ alert('Post j√° removido'); return; }
    const data = doc.data();
    const isAuthor = currentUser && data.uid && currentUser.uid === data.uid;
    const modKey = getModKey();
    const allowedByKey = modKey && id.startsWith(modKey); // demo simple rule
    if(!isAuthor && !allowedByKey){
      if(!confirm('Voc√™ n√£o √© o autor. Deseja apagar (apenas confirme para demo)?')) return;
    }
    // remove image if exists
    if(data.imageURL){
      try { const ref = storage.refFromURL(data.imageURL); await ref.delete(); } catch(e){ console.warn('N√£o foi poss√≠vel deletar imagem:', e); }
    }
    await docRef.delete();
    toast('Post removido');
  } catch(e){ console.error(e); alert('Erro ao remover: ' + e); }
}

/* =========================================================
   Render posts from postsCache
   - postsCache updated in real-time snapshot
   - renderPosts applies filter and builds DOM
   ========================================================= */
function renderPosts(){
  const arr = Object.values(postsCache).sort((a,b)=>b.ts - a.ts);
  const q = $('#search').value.trim().toLowerCase();
  $('#postsFeed').innerHTML = '';
  totalLikes = 0;
  let shown = 0;
  for(const item of arr){
    if(q && !( (item.title||'').toLowerCase().includes(q) || (item.text||'').toLowerCase().includes(q) || (item.authorName||'').toLowerCase().includes(q) )) continue;
    shown++;
    totalLikes += (item.likes || 0);
    const div = document.createElement('div'); div.className = 'post';
    const date = new Date(item.ts);
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:10px;align-items:center">
          ${item.authorPhoto ? `<img src="${escapeHtml(item.authorPhoto)}" alt="" style="width:40px;height:40px;border-radius:999px;object-fit:cover" />` : ''}
          <div>
            <div style="font-weight:800">${escapeHtml(item.authorName||'an√¥nimo')}</div>
            <div class="small muted">${escapeHtml(item.title||'')}</div>
          </div>
        </div>
        <div class="small muted">${date.toLocaleString()}</div>
      </div>
      <div style="margin-top:10px">${escapeHtml(item.text||'')}</div>
      ${item.imageURL ? `<img src="${escapeHtml(item.imageURL)}" alt="imagem do post">` : ''}
      <div class="actions">
        <button class="btn ghost small" onclick="likePost('${item.id}')">‚ù§Ô∏è ${item.likes||0}</button>
        <button class="btn ghost small" onclick="sharePost('${item.id}')">Link</button>
        <button class="btn ghost small" onclick="removePost('${item.id}')">Remover</button>
      </div>
    `;
    $('#postsFeed').appendChild(div);
  }
  $('#count').textContent = Object.keys(postsCache).length;
  $('#likes-total').textContent = totalLikes;
  if(!shown) $('#postsFeed').innerHTML = '<div class="small muted">Nenhum post encontrado.</div>';
}

/* =========================================================
   Real-time subscription: onSnapshot for posts
   - keeps postsCache in sync
   ========================================================= */
function subscribeRealtime(){
  $('#fb-status').textContent = 'conectando...';
  db.collection('posts').orderBy('ts','desc')
    .onSnapshot(snapshot=>{
      snapshot.docChanges().forEach(change=>{
        const id = change.doc.id;
        const data = change.doc.data();
        const normalized = Object.assign({}, data, { id });
        if(change.type === 'added' || change.type === 'modified'){
          postsCache[id] = normalized;
        } else if(change.type === 'removed'){
          delete postsCache[id];
        }
      });
      renderPosts();
      $('#fb-status').textContent = 'online';
      $('#con-status').textContent = 'online';
    }, err=>{
      console.error('snapshot erro', err);
      $('#fb-status').textContent = 'erro';
      $('#con-status').textContent = 'erro';
    });
}

/* =========================================================
   Sharing post link helper
   ========================================================= */
function sharePost(id){
  const url = location.href.split('#')[0] + '#post-' + id;
  copyToClipboard(url);
  toast('Link do post copiado');
}

/* =========================================================
   Admin helpers: moderation, export, import
   ========================================================= */
function openModeration(){
  const el = $('#admin-panel');
  el.innerHTML = '<div class="small muted">Carregando modera√ß√£o...</div>';
  // build simple mod UI
  let html = '<div style="display:flex;gap:8px;flex-wrap:wrap">';
  html += `<button class="btn ghost" onclick="bulkDeleteFlagged()">Apagar posts marcados (demo)</button>`;
  html += `<button class="btn ghost" onclick="bulkExport()">Exportar posts (JSON)</button>`;
  html += `</div><div style="margin-top:12px" id="mod-list"></div>`;
  el.innerHTML = html;
  // list posts with checkboxes
  const modList = document.getElementById('mod-list');
  modList.innerHTML = '<div class="small muted">Carregando posts...</div>';
  db.collection('posts').orderBy('ts','desc').limit(100).get().then(snap=>{
    const nodes = [];
    snap.forEach(doc=>{
      const d = doc.data();
      nodes.push(`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:800">${escapeHtml(d.authorName||'an√¥nimo')}</div>
          <div class="small muted">${escapeHtml(d.title||'')} ‚Äî ${new Date(d.ts).toLocaleString()}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn ghost small" onclick="removePost('${doc.id}')">Apagar</button>
        </div>
      </div>`);
    });
    modList.innerHTML = nodes.join('');
  }).catch(e => { modList.innerHTML = 'Erro ao carregar posts: ' + e.message; });
}

// export posts as JSON
async function exportPosts(){
  const snap = await db.collection('posts').orderBy('ts','desc').get();
  const arr = [];
  snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'posts_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Export gerado');
}

// import sample posts (demo)
async function importSample(){
  const samples = [
    { title:'Boas-vindas', text:'Primeiro post de teste ‚Äî bem-vindo ao mega site!', ts:Date.now(), likes:0, authorName:'Sistema' },
    { title:'Dica', text:'Use este site como demo para o livro dos recordes!', ts:Date.now(), likes:0, authorName:'Sistema' }
  ];
  for(const s of samples){
    await db.collection('posts').add(s);
  }
  toast('Amostra importada');
}

/* =========================================================
   DEMO: generate N posts quickly (for testing)
   ========================================================= */
async function generateDemoPosts(n=50){
  for(let i=0;i<n;i++){
    await db.collection('posts').add({
      title: 'Demo #' + (i+1),
      text: 'Conte√∫do demo autom√°tico para testes. #' + (i+1) + ' ‚Äî criado em ' + new Date().toISOString(),
      ts: Date.now() + i,
      likes: Math.floor(Math.random()*20),
      authorName: 'DemoBot'
    });
  }
  toast(n + ' posts gerados (demo)');
}

/* =========================================================
   Export/import bulk helpers (safe)
   ========================================================= */
async function bulkExport(){
  const snap = await db.collection('posts').orderBy('ts','desc').get();
  const arr = [];
  snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'posts_bulk_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Export pronto');
}

/* =========================================================
   Utilities: importPosts from JSON (simple)
   ========================================================= */
async function importPostsFromArray(arr){
  for(const item of arr){
    const copy = Object.assign({}, item);
    delete copy.id;
    await db.collection('posts').add(copy);
  }
  toast('Import conclu√≠do');
}

/* =========================================================
   Generate huge number of DOM blocks (mega) ‚Äî used to make site "gigante"
   ========================================================= */
(function generateMegaBlocks(){
  const container = document.getElementById('megaGrid');
  let html = '';
  // we'll generate 400 blocks to make site heavy but still usable
  for(let i=1;i<=400;i++){
    html += `<div class="panel" style="padding:12px"><div style="font-weight:800">Mega bloco #${i}</div><div class="small muted">Descri√ß√£o gerada automaticamente para o bloco ${i} ‚Äî parte do conjunto massivo para recorde.</div></div>`;
  }
  container.innerHTML = html;
})();

/* =========================================================
   Subscribe real-time to Firestore 'posts' collection
   ========================================================= */
subscribeRealtime();

/* =========================================================
   Offline caching: store last N posts in localStorage for offline view
   - Saves snapshot every time we update postsCache
   ========================================================= */
function savePostsCacheLocal(){
  try{
    const arr = Object.values(postsCache).slice(0,200); // limit size
    localStorage.setItem('gbz_posts_cache_v1', JSON.stringify(arr));
  }catch(e){ console.warn('save cache failed', e); }
}
function loadPostsCacheLocal(){
  try{
    const str = localStorage.getItem('gbz_posts_cache_v1');
    if(!str) return;
    const arr = JSON.parse(str);
    postsCache = {};
    arr.forEach(it => postsCache[it.id] = it);
    renderPosts();
    toast('Carregado cache local (' + arr.length + ' posts)');
  }catch(e){ console.warn('load cache failed', e); }
}
// Try load on init
loadPostsCacheLocal();
// Save periodically
setInterval(savePostsCacheLocal, 1000 * 20);

/* =========================================================
   Listen to snapshot changes and persist cache + analytics
   ========================================================= */
let lastSnapshotTime = 0;
function onSnapshotUpdate(){
  savePostsCacheLocal();
  // update small analytics
  // (You could push events to analytics here)
  lastSnapshotTime = Date.now();
}
// wrap subscribeRealtime to call onSnapshotUpdate inside changes (already done inside subscribeRealtime via renderPosts call)
const originalRenderPosts = renderPosts;
renderPosts = function(){
  originalRenderPosts();
  onSnapshotUpdate();
}

/* =========================================================
   Share link handler for hash deep-linking (open post on load)
   ========================================================= */
if(location.hash && location.hash.startsWith('#post-')){
  const id = location.hash.replace('#post-','');
  // We'll show small alert when loaded (after posts arrive)
  const check = setInterval(()=>{
    if(Object.keys(postsCache).length){
      clearInterval(check);
      const p = postsCache[id];
      if(p) alert('Abrindo post: ' + (p.title || p.text.slice(0,40)));
      else alert('Post n√£o encontrado: ' + id);
    }
  }, 500);
}

/* =========================================================
   Misc helpers: fake newsletter subscribe
   ========================================================= */
function fakeSubscribe(){
  const el = $('#news-email');
  if(!el.value || !el.value.includes('@')){ $('#news-msg').textContent = 'Digite um e-mail v√°lido.'; return; }
  $('#news-msg').textContent = 'Assinatura simulada ‚Äî obrigado!';
  setTimeout(()=>$('#news-msg').textContent = '', 3000);
}

/* =========================================================
   Export posts cache (download)
   ========================================================= */
function exportPosts(){
  const arr = Object.values(postsCache);
  const blob = new Blob([JSON.stringify(arr, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'posts_cache.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Export do cache feito');
}

/* =========================================================
   Small accessibility and keyboard shortcuts
   - Press "N" to focus new post box
   - Press "S" to focus search
   ========================================================= */
window.addEventListener('keydown', (e)=>{
  if(e.key === 'N' || e.key === 'n'){ e.preventDefault(); $('#post-text').focus(); }
  if(e.key === 'S' || e.key === 's'){ e.preventDefault(); $('#search').focus(); }
  if(e.key === 'Escape'){ // close modals etc (if implemented)
    // placeholder
  }
});

/* =========================================================
   Service worker registration (optional) - register via blob
   - Single-file approach: create SW script as blob and register it.
   - Note: for full offline capability serve via https.
   ========================================================= */
(async function registerServiceWorkerInline(){
  if('serviceWorker' in navigator){
    try{
      // create service worker source
      const swSource = `
        const CACHE_NAME = 'gbz-mega-v1';
        const toCache = ['/', location.pathname];
        self.addEventListener('install', e => {
          self.skipWaiting();
          e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(toCache)).catch(()=>{}));
        });
        self.addEventListener('activate', e => { e.waitUntil(self.clients.claim()); });
        self.addEventListener('fetch', e => {
          // network-first for API calls, cache-first for navigation/static
          const url = new URL(e.request.url);
          if(url.pathname.includes('/__/') || url.pathname.includes('/firebase/') || url.pathname.includes('/posts')){
            e.respondWith(fetch(e.request).catch(()=>caches.match(e.request)));
            return;
          }
          e.respondWith(caches.match(e.request).then(r => r || fetch(e.request)));
        });
      `;
      const blob = new Blob([swSource], {type: 'text/javascript'});
      const swUrl = URL.createObjectURL(blob);
      await navigator.serviceWorker.register(swUrl);
      console.log('SW registrado (inline)');
    }catch(e){ console.warn('SW registro falhou', e); }
  }
})();

/* =========================================================
   Final notes: ensure Firestore rules in console are configured.
   Example permissive rules for dev (NOT for production):
   service cloud.firestore {
     match /databases/{database}/documents {
       match /posts/{doc} {
         allow read, write: if true;
       }
     }
   }
   ========================================================= */

</script>
</body>
</html>
